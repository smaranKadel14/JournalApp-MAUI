 @*
    Register Page - User Registration Component
    ==========================================
    Purpose: Handles new user account creation and registration
    
    Features:
    - User registration form with validation
    - Username, email, and password input fields
    - Password confirmation for accuracy
    - Real-time validation using ValidationService
    - Secure password hashing before storage
*@
@page "/signup"

@using JournalApp.Models
@using JournalApp.Data
@using JournalApp.Services
@using Microsoft.EntityFrameworkCore
@inject AppDbContext DB
@inject NavigationManager Nav
@inject PasswordHasherService PasswordHasher

<!-- Registration Page Container -->
<div class="login-container">
    <div class="login-card">
        <h2 class="welcome-text">Welcome to Journal Application</h2>

        <!-- Username Input -->
        <div class="input-group">
            <label>Username</label>
            <input type="text" placeholder="Enter username" @bind="username" />
        </div>

        <!-- Email Input -->
        <div class="input-group">
            <label>Email</label>
            <input type="email" placeholder="Enter email" @bind="email" />
        </div>

        <!-- Password Input -->
        <div class="input-group">
            <label>Password</label>
            <input type="password" placeholder="Enter password" @bind="password" />
        </div>

        <!-- Confirm Password -->
        <div class="input-group">
            <label>Retype Password</label>
            <input type="password" placeholder="Confirm password" @bind="confirmPassword" />
        </div>

        <!-- Error Message Display -->
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <p style="color:red; font-size: 0.8rem; margin-bottom: 10px;">@errorMessage</p>
        }

        <!-- Register Button -->
        <button class="primary-btn" @onclick="HandleRegister">Sign up</button>

        <!-- Footer Links -->
        <p class="footer-text">
            Already have an account? <a href="" @onclick="GoToLogin">Login here</a>
        </p>
        
        <p class="footer-text">
            <a href="" @onclick="GoToHome">← Back to Home</a>
        </p>
    </div>
</div>

@code {
    /// Username input field value
    private string username = "";
    
    /// Email input field value
    private string email = "";
    
    /// Password input field value
    private string password = "";
    
    /// Password confirmation input field value
    private string confirmPassword = "";
    
    /// Error message displayed to user on validation or registration failure
    private string errorMessage = "";

    /// Handles user registration with validation and password hashing
    private async Task HandleRegister()
    {
        errorMessage = "";

        var (usernameValid, usernameError) = ValidationService.ValidateUsername(username);
        if (!usernameValid)
        {
            errorMessage = usernameError;
            return;
        }

        var (emailValid, emailError) = ValidationService.ValidateEmail(email);
        if (!emailValid)
        {
            errorMessage = emailError;
            return;
        }

        var (passwordValid, passwordError) = ValidationService.ValidatePassword(password);
        if (!passwordValid)
        {
            errorMessage = passwordError;
            return;
        }

        if (password != confirmPassword)
        {
            errorMessage = "Passwords do not match!";
            return;
        }

        try
        {
            var userExists = await DB.Users.AnyAsync(u => u.Email == email);
            if (userExists)
            {
                errorMessage = "Email already registered.";
                return;
            }

            var hashedPassword = PasswordHasher.HashPassword(password);

            var newUser = new User
            {
                Username = username,
                Email = email,
                Password = hashedPassword
            };

            DB.Users.Add(newUser);
            await DB.SaveChangesAsync();

            Nav.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            errorMessage = "Database error: " + ex.Message;
        }
    }

    /// Navigates to the login page
    private void GoToLogin()
    {
        Nav.NavigateTo("/login");
    }
    
    /// Navigates back to the home page
    private void GoToHome()
    {
        Nav.NavigateTo("/");
    }
}
