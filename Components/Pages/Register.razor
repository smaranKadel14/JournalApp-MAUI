 @page "/signup"

@*
    REGISTER PAGE (SQLite + EF Core)
    - Purpose: Create a new user account
    - Validation: required fields + password match + duplicate email check
    - Storage: Saves new user into SQLite database using AppDbContext
    - After success -> redirect to Login page
*@

@using JournalApp.Models
@using JournalApp.Data
@using JournalApp.Services
@using Microsoft.EntityFrameworkCore
@inject AppDbContext DB
@inject NavigationManager Nav
@inject PasswordHasherService PasswordHasher

<div class="login-container">
    <div class="login-card">
        <!-- Page Title -->
        <h2 class="welcome-text">Welcome to Journal Application</h2>

        <!-- Username input -->
        <div class="input-group">
            <label>Username</label>
            <input type="text" placeholder="Enter username" @bind="username" />
        </div>

        <!-- Email input -->
        <div class="input-group">
            <label>Email</label>
            <input type="email" placeholder="Enter email" @bind="email" />
        </div>

        <!-- Password input -->
        <div class="input-group">
            <label>Password</label>
            <input type="password" placeholder="Enter password" @bind="password" />
        </div>

        <!-- Confirm Password -->
        <div class="input-group">
            <label>Retype Password</label>
            <input type="password" placeholder="Confirm password" @bind="confirmPassword" />
        </div>

        <!-- Error message display -->
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <p style="color:red; font-size: 0.8rem; margin-bottom: 10px;">@errorMessage</p>
        }

        <!-- Register button triggers HandleRegister() -->
        <button class="primary-btn" @onclick="HandleRegister">Sign up</button>

        <!-- Link back to login -->
        <p class="footer-text">
            Already have an account? <a href="" @onclick="GoToLogin">Login here</a>
        </p>
        
        <!-- Back to Home -->
        <p class="footer-text">
            <a href="" @onclick="GoToHome">← Back to Home</a>
        </p>
    </div>
</div>

@code {
    // Bound input values
    private string username = "";
    private string email = "";
    private string password = "";
    private string confirmPassword = "";

    // Error message shown in UI when validation fails or DB has issues
    private string errorMessage = "";

    /// <summary>
    /// Handles user registration with proper validation and password hashing:
    /// 1) Validate inputs using ValidationService
    /// 2) Check if email already exists
    /// 3) Hash password using PasswordHasherService
    /// 4) Insert user into SQLite database
    /// 5) Redirect to login
    /// </summary>
    private async Task HandleRegister()
    {
        errorMessage = "";

        // 1) Validate username
        var (usernameValid, usernameError) = ValidationService.ValidateUsername(username);
        if (!usernameValid)
        {
            errorMessage = usernameError;
            return;
        }

        // 2) Validate email
        var (emailValid, emailError) = ValidationService.ValidateEmail(email);
        if (!emailValid)
        {
            errorMessage = emailError;
            return;
        }

        // 3) Validate password
        var (passwordValid, passwordError) = ValidationService.ValidatePassword(password);
        if (!passwordValid)
        {
            errorMessage = passwordError;
            return;
        }

        // 4) Check password confirmation
        if (password != confirmPassword)
        {
            errorMessage = "Passwords do not match!";
            return;
        }

        try
        {
            // 5) Ensure email is unique (prevents duplicates)
            var userExists = await DB.Users.AnyAsync(u => u.Email == email);
            if (userExists)
            {
                errorMessage = "Email already registered.";
                return;
            }

            // 6) Hash the password for security
            var hashedPassword = PasswordHasher.HashPassword(password);

            // 7) Create User object to save with hashed password
            var newUser = new User
            {
                Username = username,
                Email = email,
                Password = hashedPassword // Store hashed password, not plain text
            };

            // 8) Add and save to SQLite (journal.db)
            DB.Users.Add(newUser);
            await DB.SaveChangesAsync();

            // 9) Redirect after successful registration
            Nav.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            // Handle any unexpected database/runtime exceptions
            errorMessage = "Database error: " + ex.Message;
        }
    }
    
    private void GoToLogin()
    {
        Nav.NavigateTo("/login");
    }
    
    private void GoToHome()
    {
        Nav.NavigateTo("/");
    }
}
