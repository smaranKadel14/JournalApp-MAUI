@*
    Entries Page - Comprehensive Journal Entry Management
    =================================================
    Purpose: Browse, search, filter, and manage all journal entries
    
    Features:
    - Advanced search and filtering capabilities
    - Pagination for large entry collections
    - Multiple filter criteria (date, mood, tags, text)
    - Quick access to entry editing and creation
*@
@page "/entries"

@using Microsoft.EntityFrameworkCore
@using JournalApp.Models
@using JournalApp.Utils

@inject JournalApp.Services.UserService UserSession
@inject JournalApp.Data.AppDbContext DB
@inject NavigationManager Nav

<div class="entries-wrapper">

    <!-- Entries Header -->
    <header class="entries-header">
        <div class="left">
            <h1>Entries</h1>
            <p class="subtitle">I can browse, search, and filter all my journal entries here.</p>
        </div>

        <div class="right">
            <button class="primary-btn" @onclick="GoNewEntry">
                + New Entry
            </button>
        </div>
    </header>

    <!-- Filters Section -->
    <section class="filters">
        <!-- Search Filter -->
        <div class="filter-item">
            <label>Search</label>
            <input class="input"
                   placeholder="Search title or content..."
                   @bind="SearchText"
                   @bind:event="oninput"
                   @onkeydown="OnSearchKeyDown" />
        </div>

        <!-- Mood Filter -->
        <div class="filter-item">
            <label>Mood</label>
            <select class="input" @bind="MoodFilter">
                <option value="All">All</option>
                <option value="Positive">Positive</option>
                <option value="Neutral">Neutral</option>
                <option value="Negative">Negative</option>
            </select>
        </div>

        <!-- Tags Filter -->
        <div class="filter-item">
            <label>Tags</label>
            <select class="input" @bind="TagFilter">
                <option value="All">All Tags</option>
                @foreach (var tag in AvailableTags)
                {
                    <option value="@tag">@tag</option>
                }
            </select>
        </div>

        <!-- Date Range Filters -->
        <div class="filter-item">
            <label>From Date</label>
            <InputDate class="input" @bind-Value="FromDate" />
        </div>

        <div class="filter-item">
            <label>To Date</label>
            <InputDate class="input" @bind-Value="ToDate" />
        </div>

        <!-- Filter Actions -->
        <div class="filter-actions">
            <button class="ghost-btn" @onclick="ApplyFiltersAsync" disabled="@IsLoading">
                @(IsLoading ? "Searching..." : "Search")
            </button>

            <button class="clear-btn" @onclick="ClearFiltersAsync" disabled="@IsLoading">
                Clear
            </button>
        </div>
    </section>

    <!-- Status Messages -->
    @if (IsLoading)
    {
        <p class="status-text">Loading...</p>
    }
    else if (!string.IsNullOrWhiteSpace(ErrorMessage))
    {
        <div class="error-box">@ErrorMessage</div>
    }
    else if (AllEntries.Count == 0)
    {
        <div class="empty-state">
            <p>No entries found.</p>
            <button class="ghost-btn" @onclick="GoNewEntry">Write one now</button>
        </div>
    }
    else
    {
        <!-- Entries List -->
        <div class="list">
            @foreach (var e in PagedEntries)
            {
                <div class="item" @onclick="@(() => GoEditEntry(e.Id))">
                    <!-- Entry Information -->
                    <div class="item-left">
                        <div class="date">@e.EntryDate.ToString("MMMM dd, yyyy")</div>
                        <div class="title">@e.Title</div>
                        <div class="snippet">@MakeSnippet(e.Content)</div>
                    </div>

                    <!-- Entry Metadata -->
                    <div class="item-right">
                        <div class="mood @MoodClass(e.Mood ?? "Neutral")">@e.Mood</div>
                        <div class="tags">
                            @if (!string.IsNullOrWhiteSpace(e.TagsCsv))
                            {
                                var tags = e.TagsCsv.Split(',', StringSplitOptions.RemoveEmptyEntries);
                                @foreach (var tag in tags.Take(3))
                                {
                                    <span class="tag">@tag.Trim()</span>
                                }
                                @if (tags.Length > 3)
                                {
                                    <span class="tag">+@(tags.Length - 3)</span>
                                }
                            }
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Pagination Card -->
        <div class="pagination-card">
            <div class="pagination-header">
                <div class="pagination-info">
                    <span class="pagination-text">Page @CurrentPage of @TotalPages</span>
                    <span class="pagination-text">Showing @PagedEntries.Count of @TotalEntries entries</span>
                </div>
            </div>
            
            <div class="pagination-controls">
                <button class="page-btn" @onclick="GoToFirstPage" disabled="@(CurrentPage == 1)">
                    « First
                </button>
                <button class="page-btn" @onclick="GoToPreviousPage" disabled="@(CurrentPage == 1)">
                    ‹ Previous
                </button>

                @for (int i = GetStartPage(); i <= GetEndPage(); i++)
                {
                    <button class="page-btn @(i == CurrentPage ? "active" : "")"
                            @onclick="@(() => GoToPage(i))">
                        @i
                    </button>
                }

                <button class="page-btn" @onclick="GoToNextPage" disabled="@(CurrentPage == TotalPages)">
                    Next ›
                </button>
                <button class="page-btn" @onclick="GoToLastPage" disabled="@(CurrentPage == TotalPages)">
                    Last »
                </button>
            </div>

            <!-- Page Size Selector -->
            <div class="page-size-selector">
                <label>Page size:</label>
                <select class="input" @bind="PageSize" @bind:after="OnPageSizeChanged">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
            </div>
        </div>
    }
</div>

@code {
    /// Indicates if data is currently loading
    private bool IsLoading { get; set; } = true;
    
    /// Error message displayed to user
    private string ErrorMessage { get; set; } = "";

    /// Search text for filtering entries
    private string SearchText { get; set; } = "";
    
    /// Mood filter dropdown selection
    private string MoodFilter { get; set; } = "All";
    
    /// Tag filter dropdown selection
    private string TagFilter { get; set; } = "All";
    
    /// Date range start for filtering
    private DateTime FromDate { get; set; } = DateTime.Today.AddMonths(-1);
    
    /// Date range end for filtering
    private DateTime ToDate { get; set; } = DateTime.Today;
    
    /// Available tags for filtering
    private List<string> AvailableTags { get; set; } = new();

    /// Current pagination page number
    private int CurrentPage { get; set; } = 1;
    
    /// Number of items per page
    private int PageSize { get; set; } = 10;
    
    /// Total number of entries matching current filters
    private int TotalEntries { get; set; } = 0;
    
    /// Total number of pages based on current page size
    private int TotalPages => (int)Math.Ceiling((double)TotalEntries / PageSize);
    
    /// All entries matching current filters
    private List<JournalEntry> AllEntries { get; set; } = new();
    
    /// Entries for the current page
    private List<JournalEntry> PagedEntries { get; set; } = new();

    /// Initializes the component and loads initial data
    protected override async Task OnInitializedAsync()
    {
        if (!UserSession.IsLoggedIn || UserSession.CurrentUserId is null)
        {
            Nav.NavigateTo("/login");
            return;
        }

        await LoadAvailableTagsAsync();
        await LoadEntriesAsync();
    }

    /// Loads available tags from the database for filtering
    private async Task LoadAvailableTagsAsync()
    {
        try
        {
            var userId = UserSession.CurrentUserId!.Value;
            
            var tags = await DB.JournalEntries
                .AsNoTracking()
                .Where(e => e.UserId == userId && !string.IsNullOrWhiteSpace(e.TagsCsv))
                .SelectMany(e => e.TagsCsv.Split(',', StringSplitOptions.RemoveEmptyEntries))
                .Select(tag => tag.Trim())
                .Where(tag => !string.IsNullOrWhiteSpace(tag))
                .Distinct()
                .OrderBy(tag => tag)
                .ToListAsync();

            AvailableTags = tags;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading tags: {ex.Message}");
            AvailableTags = new List<string>();
        }
    }

    /// Loads journal entries based on current filters and pagination
    private async Task LoadEntriesAsync()
    {
        IsLoading = true;
        ErrorMessage = "";

        try
        {
            var userId = UserSession.CurrentUserId!.Value;

            var q = DB.JournalEntries
                .AsNoTracking()
                .Where(e => e.UserId == userId);

            q = q.Where(e => e.EntryDate >= FromDate.Date && e.EntryDate <= ToDate.Date);

            if (!string.Equals(MoodFilter, "All", StringComparison.OrdinalIgnoreCase))
            {
                q = q.Where(e => e.Mood == MoodFilter);
            }

            if (!string.Equals(TagFilter, "All", StringComparison.OrdinalIgnoreCase))
            {
                q = q.Where(e => e.TagsCsv.Contains(TagFilter));
            }

            var s = (SearchText ?? "").Trim();
            if (!string.IsNullOrWhiteSpace(s))
            {
                var like = $"%{s}%";
                q = q.Where(e =>
                    EF.Functions.Like(e.Title, like) ||
                    EF.Functions.Like(e.Content, like));
            }

            TotalEntries = await q.CountAsync();

            AllEntries = await q
                .OrderByDescending(e => e.EntryDate)
                .Skip((CurrentPage - 1) * PageSize)
                .Take(PageSize)
                .ToListAsync();

            PagedEntries = AllEntries;

            if (CurrentPage > 1 && PagedEntries.Count == 0)
            {
                CurrentPage = 1;
                await LoadEntriesAsync();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "Failed to load entries: " + ex.Message;
        }
        finally
        {
            IsLoading = false;
        }
    }

    /// Applies current filters and reloads entries
    private async Task ApplyFiltersAsync()
    {
        CurrentPage = 1;
        await LoadEntriesAsync();
    }

    /// Clears all filters and reloads entries
    private async Task ClearFiltersAsync()
    {
        SearchText = "";
        MoodFilter = "All";
        TagFilter = "All";
        FromDate = DateTime.Today.AddMonths(-1);
        ToDate = DateTime.Today;
        CurrentPage = 1;
        await LoadEntriesAsync();
    }

    /// Handles Enter key press in search field
    private async Task OnSearchKeyDown(Microsoft.AspNetCore.Components.Web.KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await ApplyFiltersAsync();
    }
    /// Navigates to the new entry page
    private void GoNewEntry()
    {
        Nav.NavigateTo("/new-entry");
    }

    /// Navigates to edit page for a specific entry
    /// <param name="id">Entry ID to edit</param>
    private void GoEditEntry(int id)
    {
        Nav.NavigateTo($"/new-entry/{id}");
    }

    /// Navigates to a specific page number
    /// <param name="page">Page number to navigate to</param>
    private async Task GoToPage(int page)
    {
        if (page >= 1 && page <= TotalPages)
        {
            CurrentPage = page;
            await LoadEntriesAsync();
        }
    }

    /// Navigates to the first page
    private async Task GoToFirstPage()
    {
        await GoToPage(1);
    }

    /// Navigates to the previous page
    private async Task GoToPreviousPage()
    {
        await GoToPage(CurrentPage - 1);
    }

    /// Navigates to the next page
    private async Task GoToNextPage()
    {
        await GoToPage(CurrentPage + 1);
    }

    /// Navigates to the last page
    private async Task GoToLastPage()
    {
        await GoToPage(TotalPages);
    }

    /// Handles page size change and resets to first page
    private async Task OnPageSizeChanged()
    {
        CurrentPage = 1;
        await LoadEntriesAsync();
    }

    /// Calculates the starting page number for pagination display
    /// <returns>Starting page number</returns>
    private int GetStartPage()
    {
        int maxVisiblePages = 5;
        int halfVisible = maxVisiblePages / 2;
        
        if (TotalPages <= maxVisiblePages)
            return 1;
        
        int start = CurrentPage - halfVisible;
        if (start < 1)
            start = 1;
        
        int end = start + maxVisiblePages - 1;
        if (end > TotalPages)
        {
            start = TotalPages - maxVisiblePages + 1;
            if (start < 1)
                start = 1;
        }
        
        return start;
    }

    /// Calculates the ending page number for pagination display
    /// <returns>Ending page number</returns>
    private int GetEndPage()
    {
        int maxVisiblePages = 5;
        int start = GetStartPage();
        int end = start + maxVisiblePages - 1;
        
        if (end > TotalPages)
            return TotalPages;
        
        return end;
    }

    /// Creates a text snippet from HTML content for display
    /// <param name="html">HTML content to strip</param>
    /// <returns>Plain text snippet (max 90 characters)</returns>
    private string MakeSnippet(string html)
    {
        var text = Util.StripHtml(html ?? "");

        if (string.IsNullOrWhiteSpace(text))
            return "";

        return text.Length > 90 ? text.Substring(0, 90) + "..." : text;
    }

    /// Maps mood string to CSS class for styling
    /// <param name="mood">Mood string</param>
    /// <returns>CSS class name</returns>
    private string MoodClass(string mood)
    {
        return mood switch
        {
            "Positive" => "positive",
            "Negative" => "negative",
            _ => "neutral"
        };
    }
}
