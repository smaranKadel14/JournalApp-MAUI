@*
    Calendar Page - Interactive Calendar View for Journal Entries
    ========================================================
    Purpose: Calendar-based navigation and overview of journal entries
    
    Features:
    - Monthly calendar view with entry indicators
    - Navigation between months
    - Quick entry creation from calendar
    - Visual indicators for entries per day
    - Hover effects for enhanced interactivity
*@
@page "/calendar"

@using Microsoft.EntityFrameworkCore
@using JournalApp.Models

@inject JournalApp.Services.UserService UserSession
@inject JournalApp.Data.AppDbContext DB
@inject NavigationManager Nav

<div class="cal-wrap">

    <!-- Calendar Header -->
    <div class="cal-topbar">
        <div class="cal-title">
            <div class="cal-icon">📅</div>
            <div>
                <div class="cal-heading">Calendar</div>
                <div class="cal-sub">Navigate your journal by date</div>
            </div>
        </div>

        <!-- Calendar Actions -->
        <div class="cal-actions">
            <button class="cal-btn ghost" @onclick="GoToday">Today</button>
            <button class="cal-btn" @onclick="CreateToday">New Entry</button>
        </div>
    </div>

    <!-- Month Navigation Toolbar -->
    <div class="cal-toolbar">
        <button class="cal-nav" @onclick="PrevMonth" aria-label="Previous month">‹</button>
        <div class="cal-month">@CurrentMonth.ToString("MMMM yyyy")</div>
        <button class="cal-nav" @onclick="NextMonth" aria-label="Next month">›</button>
    </div>

    <!-- Calendar Grid -->
    <div class="cal-grid">
        <!-- Day Names Header -->
        @foreach (var name in DayNames)
        {
            <div class="cal-dow">@name</div>
        }

        <!-- Calendar Cells -->
        @foreach (var cell in Cells)
        {
            var day = cell.Date.Date;
            var isToday = day == DateTime.Today;
            var isMuted = !cell.InCurrentMonth;

            EntriesByDay.TryGetValue(day, out var dayEntries);
            dayEntries ??= EmptyEntries;

            <div class="cal-cell @(isMuted ? "muted" : "") @(isToday ? "today" : "")"
                 @onmouseenter="() => HoveredDay = day"
                 @onmouseleave="() => HoveredDay = null">

                <!-- Cell Header with Day Number and Add Button -->
                <div class="cal-cell-head">
                    <div class="cal-daynum">@cell.Date.Day</div>

                    <button class="cal-plus @(HoveredDay == day ? "show" : "")"
                            title="Create entry"
                            @onclick="() => OpenDay(day)">
                        +
                    </button>
                </div>

                <!-- Events List -->
                <div class="cal-events">
                    @foreach (var e in dayEntries.Take(3))
                    {
                        <button class="cal-chip"
                                title="Open entry"
                                @onclick="() => OpenEntry(e.Id)">
                            <div class="chip-title">@TrimTo(e.Title, 22)</div>
                            <div class="chip-sub">@FormatMood(e.Mood)</div>
                        </button>
                    }

                    @if (dayEntries.Count > 3)
                    {
                        <div class="cal-more">+@(dayEntries.Count - 3) more</div>
                    }
                </div>
            </div>
        }
    </div>

</div>

@code {
    /// Day names for calendar header (Monday to Sunday)
    private static readonly string[] DayNames = new[] { "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun" };

    /// Currently displayed month
    private DateTime CurrentMonth = new(DateTime.Today.Year, DateTime.Today.Month, 1);

    /// Calendar cells for the current month view
    private List<CalendarCell> Cells = new();
    
    /// Dictionary mapping dates to journal entries
    private Dictionary<DateTime, List<JournalEntry>> EntriesByDay = new();
    
    /// Currently hovered day for UI interactions
    private DateTime? HoveredDay;

    /// Empty list placeholder for days with no entries
    private static readonly List<JournalEntry> EmptyEntries = new();

    /// Initializes the calendar component and loads initial data
    protected override async Task OnInitializedAsync()
    {
        if (!UserSession.IsLoggedIn || UserSession.CurrentUserId is null)
        {
            Nav.NavigateTo("/login");
            return;
        }

        await LoadMonthAsync();
    }

    /// Opens the new entry page for a specific date
    /// <param name="date">Date to create entry for</param>
    private void OpenDay(DateTime date)
    {
        var iso = date.ToString("yyyy-MM-dd");
        Nav.NavigateTo($"/new-entry?date={iso}");
    }

    /// Opens an existing journal entry for editing
    /// <param name="entryId">Entry ID to open</param>
    private void OpenEntry(int entryId)
    {
        Nav.NavigateTo($"/new-entry/{entryId}");
    }

    /// Navigates to the previous month
    private async Task PrevMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(-1);
        await LoadMonthAsync();
    }

    /// Navigates to the next month
    private async Task NextMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(1);
        await LoadMonthAsync();
    }

    /// Navigates to the current month
    private async Task GoToday()
    {
        CurrentMonth = new(DateTime.Today.Year, DateTime.Today.Month, 1);
        await LoadMonthAsync();
    }

    /// Creates a new entry for today's date
    private void CreateToday()
    {
        OpenDay(DateTime.Today);
    }

    /// Loads calendar cells and entries for the current month
    private async Task LoadMonthAsync()
    {
        BuildCellsMondayStart();
        await LoadEntriesForMonthAsync();
        StateHasChanged();
    }

    /// Builds calendar cells with Monday as the first day of the week
    private void BuildCellsMondayStart()
    {
        Cells.Clear();

        var first = CurrentMonth.Date;
        int offset = ((int)first.DayOfWeek + 6) % 7;
        var start = first.AddDays(-offset);

        for (int i = 0; i < 42; i++)
        {
            var d = start.AddDays(i);
            Cells.Add(new CalendarCell(d, d.Month == CurrentMonth.Month));
        }
    }

    /// Loads journal entries for the current month from the database
    private async Task LoadEntriesForMonthAsync()
    {
        EntriesByDay.Clear();

        var userId = UserSession.CurrentUserId!.Value;
        var start = CurrentMonth.Date;
        var end = CurrentMonth.AddMonths(1).Date;

        var rows = await DB.JournalEntries
            .Where(e => e.UserId == userId && e.EntryDate >= start && e.EntryDate < end)
            .OrderBy(e => e.EntryDate)
            .ThenByDescending(e => e.UpdatedAt)
            .ToListAsync();

        foreach (var e in rows)
        {
            var day = e.EntryDate.Date;
            if (!EntriesByDay.TryGetValue(day, out var list))
            {
                list = new List<JournalEntry>();
                EntriesByDay[day] = list;
            }
            list.Add(e);
        }
    }

    /// Trims a string to a specified length with ellipsis
    /// <param name="s">String to trim</param>
    /// <param name="len">Maximum length</param>
    /// <returns>Trimmed string with ellipsis if needed</returns>
    private static string TrimTo(string? s, int len)
    {
        if (string.IsNullOrWhiteSpace(s)) return "(No title)";
        s = s.Trim();
        return s.Length <= len ? s : s.Substring(0, len - 1) + "…";
    }

    /// Formats the mood string for display
    /// <param name="mood">Mood string</param>
    /// <returns>Formatted mood string</returns>
    private static string FormatMood(string? mood)
    {
        if (string.IsNullOrWhiteSpace(mood)) return "Mood: Neutral";
        return $"Mood: {mood}";
    }

    /// Represents a calendar cell with date and month information
    /// <param name="Date">Cell date</param>
    /// <param name="InCurrentMonth">Whether the date is in the current month</param>
    private record CalendarCell(DateTime Date, bool InCurrentMonth);
}
