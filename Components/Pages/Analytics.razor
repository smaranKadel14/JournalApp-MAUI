@using JournalApp.Services
@using Microsoft.AspNetCore.Components.Forms

@inject AnalyticsService AnalyticsService
@inject JournalApp.Services.UserService UserSession

@*
   Analytics Component (Date-range filterable)
   - Mood Distribution (Pie + bars)
   - Most Frequent Mood
   - Daily Streak + Longest Streak
   - Missed Days list
   - Most Used Tags (bars)
   - Tag Breakdown (% of entries per tag-category)
   - Word Count Trend (avg words per entry per day)
*@

<section class="analytics-shell">
    <div class="analytics-header">
        <div class="analytics-title">
            <h2 class="analytics-h">Analytics & Insights</h2>
            <p class="analytics-sub">
                Filter by date range to see your mood, streaks, tags, missed days, and writing trends.
            </p>
        </div>

        <div class="analytics-range">
            <span class="analytics-badge">@($"{FromDate:MMM dd} → {ToDate:MMM dd}")</span>
        </div>
    </div>

    <!-- Date range controls -->
    <div class="analytics-controls">
        <div class="control-field">
            <div class="control-label">From</div>
            <div class="control-input">
                <InputDate class="date-input" @bind-Value="FromDate" />
            </div>
        </div>

        <div class="control-field">
            <div class="control-label">To</div>
            <div class="control-input">
                <InputDate class="date-input" @bind-Value="ToDate" />
            </div>
        </div>

        <div class="control-actions">
            <button type="button" class="btn-pink" @onclick="LoadAnalytics" disabled="@IsLoading">
                <span class="btn-ico" aria-hidden="true">↻</span>
                <span>@(IsLoading ? "Loading..." : "Refresh")</span>
            </button>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(Error))
    {
        <div class="error-box analytics-msg">@Error</div>
    }

    @if (Result is not null)
    {
        <!-- Summary cards -->
        <div class="summary-grid">
            <div class="summary-card">
                <div class="summary-top">
                    <div class="summary-icon" aria-hidden="true">⭐</div>
                    <div class="summary-meta">
                        <div class="summary-label">Most Frequent Mood</div>
                        <div class="summary-value">@Result.MostFrequentMood</div>
                    </div>
                </div>
            </div>

            <div class="summary-card">
                <div class="summary-top">
                    <div class="summary-icon" aria-hidden="true">🔥</div>
                    <div class="summary-meta">
                        <div class="summary-label">Daily Streak</div>
                        <div class="summary-value">@Result.CurrentStreak <span class="summary-unit">days</span></div>
                        <div class="summary-help">(Ending at @ToDate.ToString("MMM dd"))</div>
                    </div>
                </div>
            </div>

            <div class="summary-card">
                <div class="summary-top">
                    <div class="summary-icon" aria-hidden="true">🏆</div>
                    <div class="summary-meta">
                        <div class="summary-label">Longest Streak</div>
                        <div class="summary-value">@Result.LongestStreak <span class="summary-unit">days</span></div>
                        <div class="summary-help">(Within this range)</div>
                    </div>
                </div>
            </div>

            <div class="summary-card">
                <div class="summary-top">
                    <div class="summary-icon" aria-hidden="true">📒</div>
                    <div class="summary-meta">
                        <div class="summary-label">Total Entries</div>
                        <div class="summary-value">@Result.TotalEntries</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mood Distribution + Missed Days -->
        <div class="grid-2">
            <div class="analytics-card">
                <div class="card-head">
                    <div>
                        <div class="card-title">Mood Distribution</div>
                        <div class="card-desc">% of Positive / Neutral / Negative moods</div>
                    </div>
                </div>

                <div class="mood-wrap">
                    <!-- Pie chart -->
                    <div class="mood-pie">
                        @if (Result.TotalEntries == 0)
                        {
                            <div class="card-desc" style="margin-top:18px;">No data</div>
                        }
                        else
                        {
                            <svg viewBox="0 0 42 42" width="170" height="170" role="img" aria-label="Mood pie chart">
                                @{
                                    var p = GetPct("Positive");
                                    var n = GetPct("Neutral");
                                    var g = GetPct("Negative");
                                    var offset = 25; // start position
                                }

                                <!-- Background ring -->
                                <circle cx="21" cy="21" r="15.9155" fill="transparent"
                                        stroke="var(--surface-2)" stroke-width="8" />

                                <!-- Positive -->
                                <circle cx="21" cy="21" r="15.9155" fill="transparent"
                                        stroke="var(--accent)" stroke-width="8"
                                        stroke-dasharray="@($"{p} {100 - p}")"
                                        stroke-dashoffset="@offset" />

                                <!-- Neutral -->
                                @{
                                    offset -= p;
                                }
                                <circle cx="21" cy="21" r="15.9155" fill="transparent"
                                        stroke="rgba(225,107,122,0.55)" stroke-width="8"
                                        stroke-dasharray="@($"{n} {100 - n}")"
                                        stroke-dashoffset="@offset" />

                                <!-- Negative -->
                                @{
                                    offset -= n;
                                }
                                <circle cx="21" cy="21" r="15.9155" fill="transparent"
                                        stroke="rgba(225,107,122,0.28)" stroke-width="8"
                                        stroke-dasharray="@($"{g} {100 - g}")"
                                        stroke-dashoffset="@offset" />
                            </svg>
                        }
                    </div>

                    <!-- Bars -->
                    <div class="mood-bars">
                        @MoodRow("Positive", "var(--accent)")
                        @MoodRow("Neutral", "rgba(225,107,122,0.55)")
                        @MoodRow("Negative", "rgba(225,107,122,0.28)")
                    </div>
                </div>
            </div>

            <div class="analytics-card">
                <div class="card-head">
                    <div>
                        <div class="card-title">Missed Days</div>
                        <div class="card-desc">Dates in this range with no entries.</div>
                    </div>
                </div>

                @if (Result.MissedDays.Count == 0)
                {
                    <div class="card-desc" style="margin-top:12px;">No missed days 🎉</div>
                }
                else
                {
                    <div class="missed-wrap">
                        @foreach (var d in Result.MissedDays.Take(24))
                        {
                            <span class="missed-chip">@d.ToString("MMM dd")</span>
                        }

                        @if (Result.MissedDays.Count > 24)
                        {
                            <span class="missed-more">+@(Result.MissedDays.Count - 24) more</span>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- Tags -->
        <div class="grid-2">
            <div class="analytics-card">
                <div class="card-head">
                    <div>
                        <div class="card-title">Most Used Tags</div>
                        <div class="card-desc">Top tags used in this date range</div>
                    </div>
                </div>

                @if (Result.TopTags.Count == 0)
                {
                    <div class="card-desc" style="margin-top:12px;">No tags found.</div>
                }
                else
                {
                    var max = Result.TopTags.Max(x => x.Count);
                    <div class="bar-list">
                        @foreach (var t in Result.TopTags)
                        {
                            var pct = max == 0 ? 0 : (int)Math.Round(t.Count * 100.0 / max);

                            <div class="bar-item">
                                <div class="bar-top">
                                    <span class="bar-name">@t.Name</span>
                                    <span class="bar-count">@t.Count</span>
                                </div>
                                <div class="bar-track">
                                    <div class="bar-fill" style="width:@pct%; opacity:.85;"></div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="analytics-card">
                <div class="card-head">
                    <div>
                        <div class="card-title">Tag Breakdown</div>
                        <div class="card-desc">
                            % of entries per tag-category (Work, Health, Travel, etc.).
                            <span class="muted-note">One entry can count in multiple categories.</span>
                        </div>
                    </div>
                </div>

                @if (Result.TagBreakdown.Count == 0)
                {
                    <div class="card-desc" style="margin-top:12px;">No tag breakdown available.</div>
                }
                else
                {
                    <div class="bar-list">
                        @foreach (var c in Result.TagBreakdown)
                        {
                            <div class="bar-item">
                                <div class="bar-top">
                                    <span class="bar-name">@c.Name</span>
                                    <span class="bar-count">@c.Percent% (@c.Count)</span>
                                </div>
                                <div class="bar-track">
                                    <div class="bar-fill" style="width:@c.Percent%; opacity:.55;"></div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- Word Count Trend -->
        <div class="analytics-card">
            <div class="card-head">
                <div>
                    <div class="card-title">Word Count Trends</div>
                    <div class="card-desc">Average words per entry over time (per day).</div>
                </div>
            </div>

            @if (Result.AvgWordsByDay.Count == 0)
            {
                <div class="card-desc" style="margin-top:12px;">No data to plot.</div>
            }
            else
            {
                <div class="trend-box">
                    <svg viewBox="0 0 700 200" width="100%" height="200" role="img" aria-label="Average word trend">
                        @{
                            var points = BuildTrendPoints(Result.AvgWordsByDay, 700, 200, 30);
                        }
                        <polyline fill="none" stroke="var(--accent)" stroke-width="3" points="@points" opacity="0.9"></polyline>
                    </svg>
                </div>

                <div class="card-desc trend-note">
                    Showing @Result.AvgWordsByDay.Count day(s) with entries.
                </div>
            }
        </div>
    }
</section>

@code {
    private DateTime FromDate { get; set; } = DateTime.Today.AddDays(-30);
    private DateTime ToDate { get; set; } = DateTime.Today;

    private bool IsLoading { get; set; } = false;
    private string Error { get; set; } = "";

    private AnalyticsResult? Result { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (!UserSession.IsLoggedIn || UserSession.CurrentUserId is null)
            return;

        await LoadAnalytics();
    }

    private async Task LoadAnalytics()
    {
        Error = "";
        Result = null;

        if (!UserSession.IsLoggedIn || UserSession.CurrentUserId is null)
        {
            Error = "Please log in to view analytics.";
            return;
        }

        if (ToDate.Date < FromDate.Date)
        {
            Error = "Invalid range: 'To' must be after 'From'.";
            return;
        }

        IsLoading = true;

        try
        {
            var userId = UserSession.CurrentUserId.Value;
            Result = await AnalyticsService.GetInsightsAsync(userId, FromDate, ToDate);
        }
        catch (Exception ex)
        {
            Error = "Analytics failed: " + ex.Message;
        }
        finally
        {
            IsLoading = false;
        }
    }

    // ---- Mood helpers ----
    private int GetPct(string mood)
    {
        if (Result is null) return 0;
        return Result.MoodPercentages.TryGetValue(mood, out var p) ? p : 0;
    }

    private RenderFragment MoodRow(string mood, string color) => builder =>
    {
        if (Result is null) return;

        var pct = GetPct(mood);
        var count = Result.MoodCounts.TryGetValue(mood, out var c) ? c : 0;

        var seq = 0;

        builder.OpenElement(seq++, "div");
        builder.AddAttribute(seq++, "class", "mood-row");

        builder.OpenElement(seq++, "div");
        builder.AddAttribute(seq++, "class", "mood-row-top");

        builder.OpenElement(seq++, "span");
        builder.AddAttribute(seq++, "class", "mood-name");
        builder.AddContent(seq++, mood);
        builder.CloseElement();

        builder.OpenElement(seq++, "span");
        builder.AddAttribute(seq++, "class", "mood-val");
        builder.AddContent(seq++, $"{pct}% ({count})");
        builder.CloseElement();

        builder.CloseElement(); // mood-row-top

        builder.OpenElement(seq++, "div");
        builder.AddAttribute(seq++, "class", "bar-track");

        builder.OpenElement(seq++, "div");
        builder.AddAttribute(seq++, "class", "bar-fill");
        builder.AddAttribute(seq++, "style", $"width:{pct}%; background:{color};");
        builder.CloseElement();

        builder.CloseElement(); // bar-track

        builder.CloseElement(); // mood-row
    };

    /// <summary>
    /// Creates the SVG polyline points for the trend chart.
    /// </summary>
    private static string BuildTrendPoints(SortedDictionary<DateTime, int> data, int width, int height, int padding)
    {
        if (data.Count == 0) return "";

        var values = data.Values.ToList();
        var max = values.Max();
        if (max <= 0) max = 1;

        var plotW = width - (padding * 2);
        var plotH = height - (padding * 2);

        // One point case: keep it in the center
        if (data.Count == 1)
        {
            var x = padding + plotW / 2;
            var y = padding + plotH / 2;
            return $"{x},{y}";
        }

        var parts = new List<string>(data.Count);
        var i = 0;

        foreach (var kv in data)
        {
            var x = padding + (int)Math.Round(plotW * (i / (double)(data.Count - 1)));
            var normalized = kv.Value / (double)max;                // 0..1
            var y = padding + (int)Math.Round(plotH * (1 - normalized)); // invert for SVG
            parts.Add($"{x},{y}");
            i++;
        }

        return string.Join(" ", parts);
    }
}
