@page "/settings"
@using JournalApp.Services
@using Microsoft.AspNetCore.Components.Forms

@inject ThemeService Theme
@inject PdfExportService PdfExport
@inject UserService UserSession
@inject NavigationManager Nav

<div class="settings-wrap">

    <div class="settings-top">
        <button type="button" class="back-link" @onclick="GoBack">← Back</button>

        <div class="settings-title">
            <div class="settings-ico" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                    <path d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.6-.22l-2.39.96a7.27 7.27 0 0 0-1.63-.94l-.36-2.54A.5.5 0 0 0 13.9 1h-3.8a.5.5 0 0 0-.49.42l-.36 2.54c-.58.23-1.12.54-1.63.94l-2.39-.96a.5.5 0 0 0-.6.22L2.71 7.48a.5.5 0 0 0 .12.64l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94L2.83 14.52a.5.5 0 0 0-.12.64l1.92 3.32c.13.22.39.3.6.22l2.39-.96c.5.4 1.05.72 1.63.94l.36 2.54c.04.24.25.42.49.42h3.8c.24 0 .45-.18.49-.42l.36-2.54c.58-.23 1.12-.54 1.63-.94l2.39.96c.22.09.47 0 .6-.22l1.92-3.32a.5.5 0 0 0-.12-.64l-2.03-1.58zM12 15.5A3.5 3.5 0 1 1 12 8a3.5 3.5 0 0 1 0 7.5z" />
                </svg>
            </div>

            <div>
                <div class="settings-h">Settings</div>
                <div class="settings-sub">Personalize your JournalApp</div>
            </div>
        </div>
    </div>

    <!-- THEME -->
    <div class="settings-card">
        <div class="section-head">
            <div>
                <div class="section-title">Appearance</div>
                <div class="section-desc">Choose light or dark mode.</div>
            </div>
            <div class="badge">@Cap(SelectedTheme)</div>
        </div>

        <InputRadioGroup TValue="string"
                         class="theme-grid"
                         Value="SelectedTheme"
                         ValueChanged="OnThemeChanged"
                         ValueExpression="(() => SelectedTheme)">

            <label class="theme-card">
                <InputRadio class="theme-radio" Value="@("light")" />
                <div class="theme-inner">
                    <div class="preview light">
                        <div class="p-top"></div>
                        <div class="p-row"></div>
                        <div class="p-row"></div>
                    </div>
                    <div class="theme-text">
                        <div class="theme-name">Light</div>
                        <div class="theme-desc">Bright & clean</div>
                    </div>
                </div>
            </label>

            <label class="theme-card">
                <InputRadio class="theme-radio" Value="@("dark")" />
                <div class="theme-inner">
                    <div class="preview dark">
                        <div class="p-top"></div>
                        <div class="p-row"></div>
                        <div class="p-row"></div>
                    </div>
                    <div class="theme-text">
                        <div class="theme-name">Dark</div>
                        <div class="theme-desc">Soft on eyes</div>
                    </div>
                </div>
            </label>

        </InputRadioGroup>

        <div class="tip">Tip: Your choice is saved and stays after restarting the app.</div>

        @* Remove later if you want *@
        <div style="margin-top:10px; font-weight:700;">
            @Theme.CssClass
        </div>
    </div>

    <!-- EXPORT PDF -->
    <div class="settings-card" style="margin-top: 14px;">
        <div class="section-head">
            <div>
                <div class="section-title">Export Journals (PDF)</div>
                <div class="section-desc">Export multiple entries as a PDF by date range.</div>
            </div>
        </div>

        <div class="export-grid">
            <div class="export-field">
                <div class="export-label">From</div>
                <div class="export-input">
                    <InputDate class="date-input" @bind-Value="FromDate" />
                </div>
            </div>

            <div class="export-field">
                <div class="export-label">To</div>
                <div class="export-input">
                    <InputDate class="date-input" @bind-Value="ToDate" />
                </div>
            </div>

            <div class="export-actions">
                <button type="button" class="btn-pink" @onclick="ExportPdf" disabled="@IsExporting">
                    <span class="btn-ico" aria-hidden="true">⬇</span>
                    <span>@(IsExporting ? "Exporting..." : "Export PDF")</span>
                </button>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(ExportMessage))
        {
            <div class="info-box" style="margin-top: 12px; white-space: pre-line;">
                @ExportMessage
            </div>
        }

        @if (!string.IsNullOrWhiteSpace(ExportError))
        {
            <div class="error-box" style="margin-top: 12px;">
                @ExportError
            </div>
        }
    </div>
</div>

@code {
    private string SelectedTheme { get; set; } = "light";

    private DateTime FromDate { get; set; } = DateTime.Today.AddDays(-7);
    private DateTime ToDate { get; set; } = DateTime.Today;

    private bool IsExporting { get; set; } = false;
    private string ExportMessage { get; set; } = "";
    private string ExportError { get; set; } = "";

    protected override void OnInitialized()
    {
        SelectedTheme = Theme.CurrentTheme;
        Theme.OnChange += HandleThemeChanged;
    }

    private void HandleThemeChanged()
    {
        SelectedTheme = Theme.CurrentTheme;
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Theme.OnChange -= HandleThemeChanged;
    }

    private void GoBack() => Nav.NavigateTo("/dashboard");

    private void OnThemeChanged(string value)
    {
        SelectedTheme = value;
        Theme.SetTheme(value);
    }

    private async Task ExportPdf()
    {
        ExportError = "";
        ExportMessage = "";

        if (!UserSession.IsLoggedIn || UserSession.CurrentUserId is null)
        {
            ExportError = "You must be logged in to export.";
            Nav.NavigateTo("/login");
            return;
        }

        if (ToDate.Date < FromDate.Date)
        {
            ExportError = "Invalid range: 'To' must be after 'From'.";
            return;
        }

        IsExporting = true;

        try
        {
            var userId = UserSession.CurrentUserId.Value;

            var path = await PdfExport.ExportEntriesAsync(userId, FromDate, ToDate);

            ExportMessage = $"Exported PDF:\n{path}";

            var folder = Path.GetDirectoryName(path);
            if (!string.IsNullOrWhiteSpace(folder))
                System.Diagnostics.Process.Start("explorer.exe", folder);
        }
        catch (Exception ex)
        {
            ExportError = "Export failed: " + ex.Message;
        }
        finally
        {
            IsExporting = false;
        }
    }

    private static string Cap(string s)
    {
        if (string.IsNullOrWhiteSpace(s)) return s;
        return char.ToUpperInvariant(s[0]) + s.Substring(1);
    }
}
