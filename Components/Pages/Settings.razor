@page "/settings"
@using JournalApp.Services
@using Microsoft.AspNetCore.Components.Forms

@inject ThemeService Theme
@inject PdfExportService PdfExport
@inject UserService UserSession
@inject NavigationManager Nav

<div class="settings-wrap">

    <div class="settings-top">
        <button type="button" class="back-link" @onclick="GoBack">← Back</button>

        <div class="settings-title">
            <div class="settings-ico" aria-hidden="true">
                <img src="/icons/settings.svg" width="18" height="18" alt="Settings" />
            </div>

            <div>
                <div class="settings-h">Settings</div>
                <div class="settings-sub">Personalize your JournalApp</div>
            </div>
        </div>
    </div>

    <!-- THEME -->
    <div class="settings-card">
        <div class="section-head">
            <div>
                <div class="section-title">Appearance</div>
                <div class="section-desc">Choose light or dark mode.</div>
            </div>
            <div class="badge">@Cap(SelectedTheme)</div>
        </div>

        <InputRadioGroup TValue="string"
                         class="theme-grid"
                         Value="SelectedTheme"
                         ValueChanged="OnThemeChanged"
                         ValueExpression="(() => SelectedTheme)">

            <label class="theme-card">
                <InputRadio class="theme-radio" Value="@("light")" />
                <div class="theme-inner">
                    <div class="preview light">
                        <div class="p-top"></div>
                        <div class="p-row"></div>
                        <div class="p-row"></div>
                    </div>
                    <div class="theme-text">
                        <div class="theme-name">Light</div>
                        <div class="theme-desc">Bright & clean</div>
                    </div>
                </div>
            </label>

            <label class="theme-card">
                <InputRadio class="theme-radio" Value="@("dark")" />
                <div class="theme-inner">
                    <div class="preview dark">
                        <div class="p-top"></div>
                        <div class="p-row"></div>
                        <div class="p-row"></div>
                    </div>
                    <div class="theme-text">
                        <div class="theme-name">Dark</div>
                        <div class="theme-desc">Soft on eyes</div>
                    </div>
                </div>
            </label>

        </InputRadioGroup>

        <div class="tip">Tip: Your choice is saved and stays after restarting the app.</div>

        @* Remove later if you want *@
        <div style="margin-top:10px; font-weight:700;">
            @Theme.CssClass
        </div>
    </div>

    <!-- EXPORT PDF -->
    <div class="settings-card" style="margin-top: 14px;">
        <div class="section-head">
            <div>
                <div class="section-title">Export Journals (PDF)</div>
                <div class="section-desc">Export multiple entries as a PDF by date range.</div>
            </div>
        </div>

        <div class="export-grid">
            <div class="export-field">
                <div class="export-label">From</div>
                <div class="export-input">
                    <InputDate class="date-input" @bind-Value="FromDate" />
                </div>
            </div>

            <div class="export-field">
                <div class="export-label">To</div>
                <div class="export-input">
                    <InputDate class="date-input" @bind-Value="ToDate" />
                </div>
            </div>

            <div class="export-actions">
                <button type="button" class="btn-pink" @onclick="ExportPdf" disabled="@IsExporting">
                    <span class="btn-ico" aria-hidden="true">⬇</span>
                    <span>@(IsExporting ? "Exporting..." : "Export PDF")</span>
                </button>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(ExportMessage))
        {
            <div class="info-box" style="margin-top: 12px; white-space: pre-line;">
                @ExportMessage
            </div>
        }

        @if (!string.IsNullOrWhiteSpace(ExportError))
        {
            <div class="error-box" style="margin-top: 12px;">
                @ExportError
            </div>
        }
    </div>

    <!-- LOGOUT -->
    <div class="settings-card" style="margin-top: 14px;">
        <div class="section-head">
            <div>
                <div class="section-title">Account</div>
                <div class="section-desc">Sign out of your JournalApp account.</div>
            </div>
        </div>

        <div class="logout-section">
            <button type="button" class="btn-pink logout-btn" @onclick="Logout">
                <span class="btn-ico" aria-hidden="true">🚪</span>
                <span>Logout</span>
            </button>
            <div class="logout-desc">You will need to login again to access your journals.</div>
        </div>
    </div>
</div>

@code {
    private string SelectedTheme { get; set; } = "light";

    private DateTime FromDate { get; set; } = DateTime.Today.AddDays(-7);
    private DateTime ToDate { get; set; } = DateTime.Today;

    private bool IsExporting { get; set; } = false;
    private string ExportMessage { get; set; } = "";
    private string ExportError { get; set; } = "";

    protected override void OnInitialized()
    {
        SelectedTheme = Theme.CurrentTheme;
        Theme.OnChange += HandleThemeChanged;
    }

    private void HandleThemeChanged()
    {
        SelectedTheme = Theme.CurrentTheme;
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Theme.OnChange -= HandleThemeChanged;
    }

    private void GoBack() => Nav.NavigateTo("/dashboard");

    private void OnThemeChanged(string value)
    {
        SelectedTheme = value;
        Theme.SetTheme(value);
    }

    private async Task ExportPdf()
    {
        ExportError = "";
        ExportMessage = "";

        if (!UserSession.IsLoggedIn || UserSession.CurrentUserId is null)
        {
            ExportError = "You must be logged in to export.";
            Nav.NavigateTo("/login");
            return;
        }

        if (ToDate.Date < FromDate.Date)
        {
            ExportError = "Invalid range: 'To' must be after 'From'.";
            return;
        }

        IsExporting = true;

        try
        {
            var userId = UserSession.CurrentUserId.Value;

            var path = await PdfExport.ExportEntriesAsync(userId, FromDate, ToDate);

            ExportMessage = $"Exported PDF:\n{path}";

            var folder = Path.GetDirectoryName(path);
            if (!string.IsNullOrWhiteSpace(folder))
                System.Diagnostics.Process.Start("explorer.exe", folder);
        }
        catch (Exception ex)
        {
            ExportError = "Export failed: " + ex.Message;
        }
        finally
        {
            IsExporting = false;
        }
    }

    private static string Cap(string s)
    {
        if (string.IsNullOrWhiteSpace(s)) return s;
        return char.ToUpperInvariant(s[0]) + s.Substring(1);
    }

    private void Logout()
    {
        UserSession.Logout();
        Nav.NavigateTo("/login");
    }
}
