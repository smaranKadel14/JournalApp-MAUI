@*
    Dashboard Page - Main User Dashboard Component
    ==============================================
    Purpose: Central hub displaying user statistics and recent journal activity
    
    Features:
    - User statistics summary (mood, streaks, entries)
    - Recent journal entries display
    - Quick access to create/edit today's entry
    - Responsive grid layout with analytics cards
*@
@page "/dashboard"

@using Microsoft.EntityFrameworkCore
@using JournalApp.Models
@using JournalApp.Components.Pages

@inject NavigationManager Nav
@inject JournalApp.Services.UserService UserSession
@inject JournalApp.Data.AppDbContext DB

<div class="dashboard-wrapper">

    <header class="dash-header">
        <div class="dash-heading">
            <h1 class="dash-h1">Dashboard</h1>
            <p class="dash-subtitle">A quick overview of your journaling</p>
        </div>

        <div class="dash-actions">
            <div class="date-chip" title="Today">
                <span class="chip-ico" aria-hidden="true">📅</span>
                <span>@DateTime.Today.ToString("MMMM dd, yyyy")</span>
            </div>

            <button class="btn-accent" @onclick="GoToTodayEntry">
                @(TodayEntryId.HasValue ? "Edit Today Entry" : "+ Add Today Entry")
            </button>
        </div>
    </header>

    <!-- Analytics Summary Cards -->
    <section class="summary-grid">
        <!-- Most Frequent Mood -->
        <div class="summary-card">
            <div class="summary-top">
                <div class="summary-icon" aria-hidden="true">⭐</div>
                <div class="summary-meta">
                    <div class="summary-label">Most Frequent Mood</div>
                    <div class="summary-value">@MostFrequentMood</div>
                </div>
            </div>
        </div>

        <!-- Daily Streak -->
        <div class="summary-card">
            <div class="summary-top">
                <div class="summary-icon" aria-hidden="true">🔥</div>
                <div class="summary-meta">
                    <div class="summary-label">Daily Streak</div>
                    <div class="summary-value">@CurrentStreak <span class="summary-unit">days</span></div>
                </div>
            </div>
        </div>

        <!-- Longest Streak -->
        <div class="summary-card">
            <div class="summary-top">
                <div class="summary-icon" aria-hidden="true">🏆</div>
                <div class="summary-meta">
                    <div class="summary-label">Longest Streak</div>
                    <div class="summary-value">@LongestStreak <span class="summary-unit">days</span></div>
                </div>
            </div>
        </div>

        <!-- Total Entries -->
        <div class="summary-card">
            <div class="summary-top">
                <div class="summary-icon" aria-hidden="true">📒</div>
                <div class="summary-meta">
                    <div class="summary-label">Total Entries</div>
                    <div class="summary-value">@TotalEntries</div>
                </div>
            </div>
        </div>
    </section>

    <Analytics />

    <!-- Recent Entries Section -->
    <section class="recent-entries">
        <div class="section-header">
            <h2 class="section-title">Recent Entries</h2>
        </div>

        @if (IsLoading)
        {
            <p class="loading-text">Loading...</p>
        }
        else if (RecentEntries.Count == 0)
        {
            <div class="empty-state">
                <p>No entries yet.</p>
                <button class="ghost-btn" @onclick="@(() => Nav.NavigateTo("/new-entry"))">
                    Write your first entry
                </button>
            </div>
        }
        else
        {
            <div class="entry-list">
                @foreach (var e in RecentEntries)
                {
                    <div class="entry-item" @onclick="@(() => Nav.NavigateTo($"/new-entry/{e.Id}"))">
                        <div class="entry-left">
                            <div class="entry-date">@e.EntryDate.ToString("MMMM dd")</div>
                            <div class="entry-title">@e.Title</div>
                            <div class="entry-snippet">@GetSnippet(e.Content)</div>
                        </div>

                        <div class="entry-right">
                            <span class="mood-pill @MoodClass(e.Mood)">@e.Mood</span>
                        </div>
                    </div>
                }
            </div>
        }
    </section>
</div>

@code {
    /// <summary>
    /// Loading state for the dashboard UI
    /// </summary>
    private bool IsLoading { get; set; } = true;

    /// <summary>
    /// Entry ID for today's journal entry if it exists
    /// </summary>
    private int? TodayEntryId { get; set; } = null;

    /// <summary>
    /// List of recent journal entries for display
    /// </summary>
    private List<JournalEntry> RecentEntries { get; set; } = new();
    
    /// <summary>
    /// Current consecutive day streak
    /// </summary>
    private int CurrentStreak { get; set; } = 0;
    
    /// <summary>
    /// Number of entries created this week
    /// </summary>
    private int EntriesThisWeek { get; set; } = 0;
    
    /// <summary>
    /// Most frequently selected mood
    /// </summary>
    private string MostFrequentMood { get; set; } = "—";

    /// <summary>
    /// Longest consecutive day streak achieved
    /// </summary>
    private int LongestStreak { get; set; } = 0;

    /// <summary>
    /// Total number of journal entries for the user
    /// </summary>
    private int TotalEntries { get; set; }

    /// <summary>
    /// Initializes the dashboard component and loads user data
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        if (!UserSession.IsLoggedIn || UserSession.CurrentUserId is null)
        {
            Nav.NavigateTo("/login");
            return;
        }

        await LoadDashboardAsync();
    }

    /// <summary>
    /// Loads all dashboard data including entries, statistics, and user information
    /// </summary>
    private async Task LoadDashboardAsync()
    {
        IsLoading = true;

        try
        {
            var userId = UserSession.CurrentUserId!.Value;
            var today = DateTime.Today;

            RecentEntries = await DB.JournalEntries
                .Where(e => e.UserId == userId)
                .OrderByDescending(e => e.EntryDate)
                .Take(10)
                .ToListAsync();

            TodayEntryId = await DB.JournalEntries
                .Where(e => e.UserId == userId && e.EntryDate == today)
                .Select(e => (int?)e.Id)
                .FirstOrDefaultAsync();

            var weekStart = today.AddDays(-6);
            EntriesThisWeek = await DB.JournalEntries
                .CountAsync(e => e.UserId == userId && e.EntryDate >= weekStart && e.EntryDate <= today);

            MostFrequentMood = RecentEntries
                .GroupBy(e => e.Mood)
                .OrderByDescending(g => g.Count())
                .Select(g => g.Key)
                .FirstOrDefault() ?? "—";

            CurrentStreak = await CalculateCurrentStreakAsync(userId);

            LongestStreak = await CalculateLongestStreakAsync(userId);

            TotalEntries = await DB.JournalEntries
                .CountAsync(e => e.UserId == userId);
        }
        finally
        {
            IsLoading = false;
        }
    }

    /// <summary>
    /// Navigates to today's entry or creates a new one if it doesn't exist
    /// </summary>
    private void GoToTodayEntry()
    {
        if (TodayEntryId.HasValue)
        {
            Nav.NavigateTo($"/new-entry/{TodayEntryId.Value}");
            return;
        }

        Nav.NavigateTo("/new-entry");
    }

    /// <summary>
    /// Calculates the current consecutive day streak ending today
    /// </summary>
    /// <param name="userId">User ID to calculate streak for</param>
    /// <returns>Number of consecutive days with entries ending today</returns>
    private async Task<int> CalculateCurrentStreakAsync(int userId)
    {
        var today = DateTime.Today;
        var start = today.AddDays(-60);

        var dates = await DB.JournalEntries
            .Where(e => e.UserId == userId && e.EntryDate >= start && e.EntryDate <= today)
            .Select(e => e.EntryDate)
            .Distinct()
            .OrderByDescending(d => d)
            .ToListAsync();

        if (!dates.Contains(today))
            return 0;

        var streak = 0;
        var check = today;

        while (dates.Contains(check))
        {
            streak++;
            check = check.AddDays(-1);
        }

        return streak;
    }

    /// <summary>
    /// Calculates the longest consecutive day streak achieved by the user
    /// </summary>
    /// <param name="userId">User ID to calculate streak for</param>
    /// <returns>Longest number of consecutive days with entries</returns>
    private async Task<int> CalculateLongestStreakAsync(int userId)
    {
        var allDates = await DB.JournalEntries
            .Where(e => e.UserId == userId)
            .Select(e => e.EntryDate)
            .Distinct()
            .OrderBy(d => d)
            .ToListAsync();

        if (allDates.Count == 0)
            return 0;

        var longestStreak = 0;
        var currentStreak = 1;
        var previousDate = allDates[0];

        for (int i = 1; i < allDates.Count; i++)
        {
            var currentDate = allDates[i];
            var daysDiff = (currentDate - previousDate).Days;

            if (daysDiff == 1)
            {
                currentStreak++;
            }
            else
            {
                longestStreak = Math.Max(longestStreak, currentStreak);
                currentStreak = 1;
            }

            previousDate = currentDate;
        }

        longestStreak = Math.Max(longestStreak, currentStreak);
        return longestStreak;
    }

    /// <summary>
    /// Creates a text snippet from entry content for preview display
    /// </summary>
    /// <param name="content">Full entry content</param>
    /// <returns>Truncated content snippet (max 60 characters)</returns>
    private string GetSnippet(string content)
    {
        if (string.IsNullOrWhiteSpace(content))
            return "";

        content = content.Replace("\r", "").Replace("\n", " ").Trim();
        return content.Length > 60 ? content.Substring(0, 60) + "..." : content;
    }

    /// <summary>
    /// Maps mood string to CSS class for styling
    /// </summary>
    /// <param name="mood">Mood string (Positive, Negative, or Neutral)</param>
    /// <returns>CSS class name for mood styling</returns>
    private string MoodClass(string mood)
    {
        return mood switch
        {
            "Positive" => "positive",
            "Negative" => "negative",
            _ => "neutral"
        };
    }
}
