@page "/dashboard"

@* Dashboard:
   - Loads current user's entries
   - Shows stats + recent entries
   - Button changes: Add Today Entry -> Edit Today Entry if today's entry exists *@

@using Microsoft.EntityFrameworkCore
@using JournalApp.Models

@inject NavigationManager Nav
@inject JournalApp.Services.UserService UserSession
@inject JournalApp.Data.AppDbContext DB

<div class="dashboard-wrapper">

    <!-- Top header with title, date, and main action button -->
    <header class="dash-header">
        <div class="dash-title">
            <h1>Dashboard</h1>
            <p class="subtitle">A quick overview of your journaling</p>
        </div>

        <div class="dash-actions">
            <span class="date-label">@DateTime.Today.ToString("MMMM dd, yyyy")</span>

            <!-- Button changes based on whether today's entry exists -->
            <button class="add-btn" @onclick="GoToTodayEntry">
                @(TodayEntryId.HasValue ? "Edit Today Entry" : "+ Add Today Entry")
            </button>
        </div>
    </header>

    <!-- Stats cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <p>Current Streak</p>
            <div class="stat-big">
                <span class="stat-number">@CurrentStreak</span>
                <span class="stat-unit">days</span>
            </div>
        </div>

        <div class="stat-card">
            <p>Most Frequent Mood</p>
            <h3>@MostFrequentMood</h3>
        </div>

        <div class="stat-card">
            <p>Entries this Week</p>
            <h3>@EntriesThisWeek</h3>
        </div>
    </div>

    <!-- Recent Entries -->
    <section class="recent-entries">
        <div class="section-header">
            <h2>Recent Entries</h2>
        </div>

        @if (IsLoading)
        {
            <p>Loading...</p>
        }
        else if (RecentEntries.Count == 0)
        {
            <div class="empty-state">
                <p>No entries yet.</p>
                <button class="ghost-btn" @onclick="@(() => Nav.NavigateTo("/new-entry"))">Write your first entry</button>
            </div>
        }
        else
        {
            <div class="entry-list">
                @foreach (var e in RecentEntries)
                {
                    <!-- Clicking an entry opens edit mode -->
                    <div class="entry-item" @onclick="@(() => Nav.NavigateTo($"/new-entry/{e.Id}"))">
                        <div class="entry-left">
                            <div class="entry-date">@e.EntryDate.ToString("MMMM dd")</div>
                            <div class="entry-title">@e.Title</div>
                            <div class="entry-snippet">@GetSnippet(e.Content)</div>
                        </div>

                        <div class="entry-right">
                            <span class="mood-pill @MoodClass(e.Mood)">@e.Mood</span>
                        </div>
                    </div>
                }
            </div>
        }
    </section>
</div>

@code {
    // Tracks loading state so UI can show "Loading..."
    private bool IsLoading { get; set; } = true;

    // Holds the entry Id for today's entry (if it exists)
    private int? TodayEntryId { get; set; } = null;

    // Dashboard data
    private List<JournalEntry> RecentEntries { get; set; } = new();
    private int CurrentStreak { get; set; } = 0;
    private int EntriesThisWeek { get; set; } = 0;
    private string MostFrequentMood { get; set; } = "—";

    protected override async Task OnInitializedAsync()
    {
        // If user is not logged in, send them to login page
        if (!UserSession.IsLoggedIn || UserSession.CurrentUserId is null)
        {
            Nav.NavigateTo("/login");
            return;
        }

        await LoadDashboardAsync();
    }

    private async Task LoadDashboardAsync()
    {
        IsLoading = true;

        try
        {
            var userId = UserSession.CurrentUserId!.Value;
            var today = DateTime.Today;

            // Load recent entries for this user (latest first)
            RecentEntries = await DB.JournalEntries
                .Where(e => e.UserId == userId)
                .OrderByDescending(e => e.EntryDate)
                .Take(10)
                .ToListAsync();

            // Find today's entry Id (if it exists)
            TodayEntryId = await DB.JournalEntries
                .Where(e => e.UserId == userId && e.EntryDate == today)
                .Select(e => (int?)e.Id)
                .FirstOrDefaultAsync();

            // Entries this week (simple approach: last 7 days including today)
            var weekStart = today.AddDays(-6);
            EntriesThisWeek = await DB.JournalEntries
                .CountAsync(e => e.UserId == userId && e.EntryDate >= weekStart && e.EntryDate <= today);

            // Most frequent mood (based on stored Mood field)
            MostFrequentMood = RecentEntries
                .GroupBy(e => e.Mood)
                .OrderByDescending(g => g.Count())
                .Select(g => g.Key)
                .FirstOrDefault() ?? "—";

            // Current streak (count continuous days ending today)
            CurrentStreak = await CalculateCurrentStreakAsync(userId);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void GoToTodayEntry()
    {
        // If today's entry exists, go to edit mode
        if (TodayEntryId.HasValue)
        {
            Nav.NavigateTo($"/new-entry/{TodayEntryId.Value}");
            return;
        }

        // Otherwise, go to new entry page (create mode)
        Nav.NavigateTo("/new-entry");
    }

    private async Task<int> CalculateCurrentStreakAsync(int userId)
    {
        // Load last ~60 days to calculate streak safely
        var today = DateTime.Today;
        var start = today.AddDays(-60);

        var dates = await DB.JournalEntries
            .Where(e => e.UserId == userId && e.EntryDate >= start && e.EntryDate <= today)
            .Select(e => e.EntryDate)
            .Distinct()
            .OrderByDescending(d => d)
            .ToListAsync();

        // No entries today = streak is 0 (you can change this rule if needed)
        if (!dates.Contains(today))
            return 0;

        // Count consecutive days backwards from today
        var streak = 0;
        var check = today;

        while (dates.Contains(check))
        {
            streak++;
            check = check.AddDays(-1);
        }

        return streak;
    }

    private string GetSnippet(string content)
    {
        // Makes a short preview line from content
        if (string.IsNullOrWhiteSpace(content))
            return "";

        content = content.Replace("\r", "").Replace("\n", " ").Trim();
        return content.Length > 60 ? content.Substring(0, 60) + "..." : content;
    }

    private string MoodClass(string mood)
    {
        // Applies a small style class based on mood type
        return mood switch
        {
            "Positive" => "positive",
            "Negative" => "negative",
            _ => "neutral"
        };
    }
}
