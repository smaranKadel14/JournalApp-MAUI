@page "/dashboard"

@* Dashboard:
   - Loads current user's entries
   - Shows stats + recent entries
   - Button changes: Add Today Entry -> Edit Today Entry if today's entry exists
   - Uses <Analytics /> component below stats *@

@using Microsoft.EntityFrameworkCore
@using JournalApp.Models
@using JournalApp.Components.Pages   @* ✅ so <Analytics /> is recognized *@

@inject NavigationManager Nav
@inject JournalApp.Services.UserService UserSession
@inject JournalApp.Data.AppDbContext DB

<div class="dashboard-wrapper">

    <!-- Header -->
    <header class="dash-header">
        <div class="dash-heading">
            <h1 class="dash-h1">Dashboard</h1>
            <p class="dash-subtitle">A quick overview of your journaling</p>
        </div>

        <div class="dash-actions">
            <div class="date-chip" title="Today">
                <span class="chip-ico" aria-hidden="true">📅</span>
                <span>@DateTime.Today.ToString("MMMM dd, yyyy")</span>
            </div>

            <button class="btn-accent" @onclick="GoToTodayEntry">
                @(TodayEntryId.HasValue ? "Edit Today Entry" : "+ Add Today Entry")
            </button>
        </div>
    </header>

    <!-- Analytics Summary Cards -->
    <section class="summary-grid">
        <!-- Most Frequent Mood -->
        <div class="summary-card">
            <div class="summary-top">
                <div class="summary-icon" aria-hidden="true">⭐</div>
                <div class="summary-meta">
                    <div class="summary-label">Most Frequent Mood</div>
                    <div class="summary-value">@MostFrequentMood</div>
                </div>
            </div>
        </div>

        <!-- Daily Streak -->
        <div class="summary-card">
            <div class="summary-top">
                <div class="summary-icon" aria-hidden="true">🔥</div>
                <div class="summary-meta">
                    <div class="summary-label">Daily Streak</div>
                    <div class="summary-value">@CurrentStreak <span class="summary-unit">days</span></div>
                </div>
            </div>
        </div>

        <!-- Longest Streak -->
        <div class="summary-card">
            <div class="summary-top">
                <div class="summary-icon" aria-hidden="true">🏆</div>
                <div class="summary-meta">
                    <div class="summary-label">Longest Streak</div>
                    <div class="summary-value">@LongestStreak <span class="summary-unit">days</span></div>
                </div>
            </div>
        </div>

        <!-- Total Entries -->
        <div class="summary-card">
            <div class="summary-top">
                <div class="summary-icon" aria-hidden="true">📒</div>
                <div class="summary-meta">
                    <div class="summary-label">Total Entries</div>
                    <div class="summary-value">@TotalEntries</div>
                </div>
            </div>
        </div>
    </section>

    @* ✅ Analytics section *@
    <Analytics />

    <!-- Recent Entries -->
    <section class="recent-entries">
        <div class="section-header">
            <h2 class="section-title">Recent Entries</h2>
        </div>

        @if (IsLoading)
        {
            <p class="loading-text">Loading...</p>
        }
        else if (RecentEntries.Count == 0)
        {
            <div class="empty-state">
                <p>No entries yet.</p>
                <button class="ghost-btn" @onclick="@(() => Nav.NavigateTo("/new-entry"))">
                    Write your first entry
                </button>
            </div>
        }
        else
        {
            <div class="entry-list">
                @foreach (var e in RecentEntries)
                {
                    <div class="entry-item" @onclick="@(() => Nav.NavigateTo($"/new-entry/{e.Id}"))">
                        <div class="entry-left">
                            <div class="entry-date">@e.EntryDate.ToString("MMMM dd")</div>
                            <div class="entry-title">@e.Title</div>
                            <div class="entry-snippet">@GetSnippet(e.Content)</div>
                        </div>

                        <div class="entry-right">
                            <span class="mood-pill @MoodClass(e.Mood)">@e.Mood</span>
                        </div>
                    </div>
                }
            </div>
        }
    </section>
</div>

@code {
    // Tracks loading state so UI can show "Loading..."
    private bool IsLoading { get; set; } = true;

    // Holds the entry Id for today's entry (if it exists)
    private int? TodayEntryId { get; set; } = null;

    // Dashboard data
    private List<JournalEntry> RecentEntries { get; set; } = new();
    private int CurrentStreak { get; set; } = 0;
    private int EntriesThisWeek { get; set; } = 0;
    private string MostFrequentMood { get; set; } = "—";

    // Add this property to provide a value for LongestStreak
    // Replace the value assignment with your actual logic as needed
    private int LongestStreak { get; set; } = 0;

    // Add this property to provide the value for TotalEntries
    private int TotalEntries { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // If user is not logged in, send them to login page
        if (!UserSession.IsLoggedIn || UserSession.CurrentUserId is null)
        {
            Nav.NavigateTo("/login");
            return;
        }

        await LoadDashboardAsync();
    }

    private async Task LoadDashboardAsync()
    {
        IsLoading = true;

        try
        {
            var userId = UserSession.CurrentUserId!.Value;
            var today = DateTime.Today;

            // Load recent entries for this user (latest first)
            RecentEntries = await DB.JournalEntries
                .Where(e => e.UserId == userId)
                .OrderByDescending(e => e.EntryDate)
                .Take(10)
                .ToListAsync();

            // Find today's entry Id (if it exists)
            TodayEntryId = await DB.JournalEntries
                .Where(e => e.UserId == userId && e.EntryDate == today)
                .Select(e => (int?)e.Id)
                .FirstOrDefaultAsync();

            // Entries this week (last 7 days including today)
            var weekStart = today.AddDays(-6);
            EntriesThisWeek = await DB.JournalEntries
                .CountAsync(e => e.UserId == userId && e.EntryDate >= weekStart && e.EntryDate <= today);

            // Most frequent mood (based on Mood field)
            MostFrequentMood = RecentEntries
                .GroupBy(e => e.Mood)
                .OrderByDescending(g => g.Count())
                .Select(g => g.Key)
                .FirstOrDefault() ?? "—";

            // Current streak (count continuous days ending today)
            CurrentStreak = await CalculateCurrentStreakAsync(userId);

            // TODO: Replace with actual logic to get the total number of entries
            // For example, if you have a list of JournalEntry objects:
            // TotalEntries = journalEntries.Count;
            TotalEntries = 0; // Placeholder value
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void GoToTodayEntry()
    {
        if (TodayEntryId.HasValue)
        {
            Nav.NavigateTo($"/new-entry/{TodayEntryId.Value}");
            return;
        }

        Nav.NavigateTo("/new-entry");
    }

    private async Task<int> CalculateCurrentStreakAsync(int userId)
    {
        var today = DateTime.Today;
        var start = today.AddDays(-60);

        var dates = await DB.JournalEntries
            .Where(e => e.UserId == userId && e.EntryDate >= start && e.EntryDate <= today)
            .Select(e => e.EntryDate)
            .Distinct()
            .OrderByDescending(d => d)
            .ToListAsync();

        if (!dates.Contains(today))
            return 0;

        var streak = 0;
        var check = today;

        while (dates.Contains(check))
        {
            streak++;
            check = check.AddDays(-1);
        }

        return streak;
    }

    private string GetSnippet(string content)
    {
        if (string.IsNullOrWhiteSpace(content))
            return "";

        content = content.Replace("\r", "").Replace("\n", " ").Trim();
        return content.Length > 60 ? content.Substring(0, 60) + "..." : content;
    }

    private string MoodClass(string mood)
    {
        return mood switch
        {
            "Positive" => "positive",
            "Negative" => "negative",
            _ => "neutral"
        };
    }
}
