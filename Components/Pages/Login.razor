@*
    Login Page - User Authentication Component
    ========================================
    Purpose: Handles user authentication and login functionality
    
    Features:
    - Username and password input fields with validation
    - Real-time form validation and error display
    - Secure password verification using BCrypt hashing
    - Navigation to signup and home pages
*@
@page "/login"

@using Microsoft.EntityFrameworkCore
@using JournalApp.Services
@using JournalApp.Data
@inject UserService UserSession
@inject AppDbContext DB
@inject NavigationManager Nav
@inject PasswordHasherService PasswordHasher

<!-- Login Page Container -->
<div class="login-container">
    <div class="login-card">
        <!-- App Branding -->
        <h1 class="brand-title">Journal</h1>
        <p class="brand-subtitle">Your Personal Space for Thoughts</p>

        <!-- Username Input -->
        <div class="input-group">
            <label>Username</label>
            <input type="text" placeholder="Enter your username" @bind="username" />
        </div>

        <!-- Password Input -->
        <div class="input-group">
            <label>Password</label>
            <input type="password" placeholder="Enter your password" @bind="password" />
        </div>

        <!-- Error Message Display -->
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <p style="color: #e66b7a; font-size: 0.85rem; margin-top: -10px; margin-bottom: 10px; text-align: left;">
                @errorMessage
            </p>
        }

        <!-- Login Button -->
        <button class="primary-btn" @onclick="HandleLogin">Login</button>

        <!-- Footer Links -->
        <p class="footer-text">
            Don't have an account? <a href="" @onclick="GoToRegister">Register here</a>
        </p>
        
        <p class="footer-text">
            <a href="" @onclick="GoToHome">← Back to Home</a>
        </p>
    </div>
</div>

@code {
    /// Username input field value
    private string username = "";
    
    /// Password input field value
    private string password = "";
    
    /// Error message displayed to user on validation or authentication failure
    private string errorMessage = "";

    /// Handles user login authentication with password verification
    private async Task HandleLogin()
    {
        errorMessage = "";

        if (string.IsNullOrWhiteSpace(username) || string.IsNullOrWhiteSpace(password))
        {
            errorMessage = "Please enter both username and password.";
            return;
        }

        try
        {
            var user = await DB.Users
                .FirstOrDefaultAsync(u => u.Username == username);

            if (user != null && PasswordHasher.VerifyPassword(user.Password, password))
            {
                UserSession.SetCurrentUser(user.Id, user.Username);
                Nav.NavigateTo("/dashboard");
            }
            else
            {
                errorMessage = "Invalid username or password.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Something went wrong while logging in.";
            Console.WriteLine(ex.Message);
        }
    }

    /// Navigates to the registration page
    private void GoToRegister()
    {
        Nav.NavigateTo("/signup");
    }
    
    /// Navigates back to the home page
    private void GoToHome()
    {
        Nav.NavigateTo("/");
    }
}
